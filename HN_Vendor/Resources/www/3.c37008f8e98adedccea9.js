(window.webpackJsonp=window.webpackJsonp||[]).push([[3],{"H+bZ":function(e,t,n){"use strict";var a=n("sE5F"),o=n("6mc2"),i=n("kScs"),r=n("mrSG"),c=function(e){function t(t,n){var a=e.call(this,t,n)||this;return a.scheduler=t,a.work=n,a.pending=!1,a}return r.__extends(t,e),t.prototype.schedule=function(e,t){if(void 0===t&&(t=0),this.closed)return this;this.state=e;var n=this.id,a=this.scheduler;return null!=n&&(this.id=this.recycleAsyncId(a,n,t)),this.pending=!0,this.delay=t,this.id=this.id||this.requestAsyncId(a,this.id,t),this},t.prototype.requestAsyncId=function(e,t,n){return void 0===n&&(n=0),setInterval(e.flush.bind(e,this),n)},t.prototype.recycleAsyncId=function(e,t,n){if(void 0===n&&(n=0),null!==n&&this.delay===n&&!1===this.pending)return t;clearInterval(t)},t.prototype.execute=function(e,t){if(this.closed)return new Error("executing a cancelled action");this.pending=!1;var n=this._execute(e,t);if(n)return n;!1===this.pending&&null!=this.id&&(this.id=this.recycleAsyncId(this.scheduler,this.id,null))},t.prototype._execute=function(e,t){var n=!1,a=void 0;try{this.work(e)}catch(o){n=!0,a=!!o&&o||new Error(o)}if(n)return this.unsubscribe(),a},t.prototype._unsubscribe=function(){var e=this.id,t=this.scheduler,n=t.actions,a=n.indexOf(this);this.work=null,this.state=null,this.pending=!1,this.scheduler=null,-1!==a&&n.splice(a,1),null!=e&&(this.id=this.recycleAsyncId(t,e,null)),this.delay=null},t}(function(e){function t(t,n){return e.call(this)||this}return r.__extends(t,e),t.prototype.schedule=function(e,t){return void 0===t&&(t=0),this},t}(n("pugT").a)),s=function(){function e(t,n){void 0===n&&(n=e.now),this.SchedulerAction=t,this.now=n}return e.prototype.schedule=function(e,t,n){return void 0===t&&(t=0),new this.SchedulerAction(this,e).schedule(n,t)},e.now=function(){return Date.now()},e}(),u=new(function(e){function t(n,a){void 0===a&&(a=s.now);var o=e.call(this,n,function(){return t.delegate&&t.delegate!==o?t.delegate.now():a()})||this;return o.actions=[],o.active=!1,o.scheduled=void 0,o}return r.__extends(t,e),t.prototype.schedule=function(n,a,o){return void 0===a&&(a=0),t.delegate&&t.delegate!==this?t.delegate.schedule(n,a,o):e.prototype.schedule.call(this,n,a,o)},t.prototype.flush=function(e){var t=this.actions;if(this.active)t.push(e);else{var n;this.active=!0;do{if(n=e.execute(e.state,e.delay))break}while(e=t.shift());if(this.active=!1,n){for(;e=t.shift();)e.unsubscribe();throw n}}},t}(s))(c);function d(){return Error.call(this),this.message="Timeout has occurred",this.name="TimeoutError",this}d.prototype=Object.create(Error.prototype);var l=d,p=n("MGBS"),h=n("zotm"),_=function(){function e(e,t,n,a){this.waitFor=e,this.absoluteTimeout=t,this.withObservable=n,this.scheduler=a}return e.prototype.call=function(e,t){return t.subscribe(new m(e,this.absoluteTimeout,this.waitFor,this.withObservable,this.scheduler))},e}(),m=function(e){function t(t,n,a,o,i){var r=e.call(this,t)||this;return r.absoluteTimeout=n,r.waitFor=a,r.withObservable=o,r.scheduler=i,r.action=null,r.scheduleTimeout(),r}return r.__extends(t,e),t.dispatchTimeout=function(e){var t=e.withObservable;e._unsubscribeAndRecycle(),e.add(Object(h.a)(e,t))},t.prototype.scheduleTimeout=function(){var e=this.action;e?this.action=e.schedule(this,this.waitFor):this.add(this.action=this.scheduler.schedule(t.dispatchTimeout,this.waitFor,this))},t.prototype._next=function(t){this.absoluteTimeout||this.scheduleTimeout(),e.prototype._next.call(this,t)},t.prototype._unsubscribe=function(){this.action=null,this.scheduler=null,this.withObservable=null},t}(p.a),b=n("6blF");var f=n("CcnG");n.d(t,"a",function(){return g});var y="http://erp20-app.heneng.cn:16681",g=function(){function e(e,t){this.http=e,this.tools=t,this.count=0}return e.prototype.GET=function(e,t,n,o){var i=this;void 0===n&&(n="\u52a0\u8f7d\u4e2d..."),void 0===o&&(o=!0),o&&this.showLoading(n);var r=y+"/"+(e||""),c=(new Date).getTime().toString()+(1e3*Math.random()+1e3).toString(),s=this.generateAccessKey(c),u=new a.j;for(var d in u.set("i",c),u.set("ak",s),localStorage.getItem("token")&&u.set("token",localStorage.getItem("token")),t=t||{})t.hasOwnProperty(d)&&u.set(d,t[d]);return u.set("sign",this.signParams(t)),new Promise(function(e,t){i.http.get(r,new a.g({search:u})).toPromise().then(function(n){i.hideLoading();var a=i.handleSuccess(n);0===a.code?e(a):t(a)}).catch(function(e){i.hideLoading();var n=i.handleError(e);t(n)})})},e.prototype.POST=function(e,t,n,o){var i=this;void 0===n&&(n="\u52a0\u8f7d\u4e2d..."),void 0===o&&(o=!0),o&&this.showLoading(n),console.log("params:====",t);var r=y+"/"+(e||""),c=(new Date).getTime().toString()+(1e3*Math.random()+1e3).toString(),s=this.generateAccessKey(c);(t=t||{}).sign=this.signParams(t),t.i=c,t.ak=s,localStorage.getItem("token")&&(t.token=localStorage.getItem("token"));var u=new a.d({"Content-Type":"application/json"}),d=new a.g({headers:u});return new Promise(function(e,n){i.http.post(r,JSON.stringify(t),d).toPromise().then(function(t){i.hideLoading();var a=i.handleSuccess(t);0===a.code?e(a):n(a)}).catch(function(e){i.hideLoading();var t=i.handleError(e);i.tools.showToast(t.message),n(t)})})},e.prototype.upload=function(e,t,n){var a=this;return void 0===t&&(t="\u6b63\u5728\u63d0\u4ea4"),void 0===n&&(n=!0),n&&this.showLoading(t),new Promise(function(t,n){var o,i,r;a.http.post("http://erp20-app.heneng.cn:16681/upload",e,null).pipe((o=12e4,void 0===i&&(i=u),function(e,t,n){return void 0===n&&(n=u),function(a){var o,i=(o=e)instanceof Date&&!isNaN(+o),r=i?+e-n.now():Math.abs(e);return a.lift(new _(r,i,t,n))}}(o,(r=new l,new b.a(function(e){return e.error(r)})),i))).toPromise().then(function(e){a.hideLoading();var o=e.json();"0"===o.code?t(o):n(o)}).catch(function(e){a.hideLoading();var t=a.handleError(e);n(t)})})},e.prototype.handleSuccess=function(e){var t=e.json();return"0"===t.code?{code:0,total:t.rowcount,data:t.data}:(this.tools.showToast(t.codemsg),{code:parseInt(t.code.toString()),message:t.codemsg})},e.prototype.handleError=function(e){var t;if(e instanceof a.h){var n=e.json()||"",o=n.error||JSON.stringify(n);t=""+o=='{"isTrusted":true}'?"\u6ca1\u6709\u7f51\u7edc\u8fde\u63a5\uff0c\u8bf7\u7a0d\u540e\u518d\u8bd5~":e.status+" - "+(e.statusText||"")+" "+o}else t=e.message?e.message:e.toString();return{code:500,message:t}},e.prototype.signParams=function(e){if(!e)return null;var t=Object.keys(e).sort();if(0===t.length)return null;var n="";return t.forEach(function(t){n+=e[t]+":"}),i.Md5.hashStr(n,!1).toString()},e.prototype.generateAccessKey=function(e){return i.Md5.hashStr(""+e.toString(),!1).toString()},e.prototype.showLoading=function(e){1==++this.count&&this.tools.showLoading(e,"lines",12e4)},e.prototype.hideLoading=function(){0==--this.count&&this.tools.hideLoading().catch(function(e){})},e.ngInjectableDef=f.defineInjectable({factory:function(){return new e(f.inject(a.e),f.inject(o.a))},token:e,providedIn:"root"}),e}()},"ajt+":function(e,t,n){"use strict";n.d(t,"a",function(){return i});var a=n("sJLo"),o=n("CcnG"),i=function(){function e(){this.hasCreatedDB=!1}return e.prototype.getDBName=function(){var e=localStorage.getItem("db.name");return e||(e="qms_"+ +new Date,localStorage.setItem("db.name",e)),e},e.prototype.createDB=function(){var e=this;return new Promise(function(t,n){if(e.db)t(e.db);else{var a=window.indexedDB;if(a){console.log("open db");var o=a.open(e.getDBName(),4);o.onerror=function(e){console.log(e),n(e.target.error.message)},o.onsuccess=function(n){e.db=o.result,e.clearTable("check_itemlist"),t(e.db)},o.onupgradeneeded=function(t){if(console.log(2121),e.db=o.result,e.db.objectStoreNames.contains("add_que")||(n=e.db.createObjectStore("add_que",{keyPath:"addque_id",autoIncrement:!0})).createIndex("check_limit",["check_type","rect_limit"],{unique:!1}),e.db.objectStoreNames.contains("que_list")||((n=e.db.createObjectStore("que_list",{keyPath:"que_id",autoIncrement:!0})).createIndex("istate","istate",{unique:!1}),n.createIndex("checkup_id","checkup_id",{unique:!1}),n.createIndex("level_id","level_id",{unique:!1}),n.createIndex("time","reg_date",{unique:!1})),e.db.objectStoreNames.contains("que_list_annexs")||((n=e.db.createObjectStore("que_list_annexs",{keyPath:"que_annex_id",autoIncrement:!0})).createIndex("IdAndType",["problem_id","annex_type"],{unique:!1}),n.createIndex("TableAndType",["table_id","annex_type"],{unique:!1}),n.createIndex("ID","annex_id",{unique:!1})),e.db.objectStoreNames.contains("que_list_record")||(n=e.db.createObjectStore("que_list_record",{keyPath:"que_record_id",autoIncrement:!0})).createIndex("problemId","problem_id",{unique:!1}),!e.db.objectStoreNames.contains("que_list_contracttype"))var n=e.db.createObjectStore("que_list_contracttype",{keyPath:"que_contracttype_id",autoIncrement:!0});e.db.objectStoreNames.contains("que_level_list")||(n=e.db.createObjectStore("que_level_list",{keyPath:"que_level_id",autoIncrement:!0})),e.db.objectStoreNames.contains("task_list_1")||((n=e.db.createObjectStore("task_list_1",{keyPath:"task_1_id",autoIncrement:!0})).createIndex("isUpdate","isupdate",{unique:!1}),n.createIndex("iscomplete","iscomplete",{unique:!1}),n.createIndex("type_complete",["checkup_id","iscomplete"],{unique:!1})),e.db.objectStoreNames.contains("task_list_2")||((n=e.db.createObjectStore("task_list_2",{keyPath:"task_2_id",autoIncrement:!0})).createIndex("planMid","plan_mid",{unique:!1}),n.createIndex("isUpdate","isupdate",{unique:!1}),n.createIndex("type_isfq",["object_type","is_fq","plan_mid"],{unique:!1}),n.createIndex("parid_isfq",["tree_parid","is_fq","plan_mid"],{unique:!1})),e.db.objectStoreNames.contains("task_list_3")||((n=e.db.createObjectStore("task_list_3",{keyPath:"task_3_id",autoIncrement:!0})).createIndex("planDid","plan_did",{unique:!1}),n.createIndex("positionName","position_name",{unique:!1}),n.createIndex("isUpdate","isupdate",{unique:!1})),e.db.objectStoreNames.contains("project_tree")||((n=e.db.createObjectStore("project_tree",{keyPath:"tree_id",autoIncrement:!0})).createIndex("type_isfq",["object_type","is_fq"],{unique:!1}),n.createIndex("parid_isfq",["tree_parid","is_fq"],{unique:!1})),e.db.objectStoreNames.contains("list_inhouse")||(n=e.db.createObjectStore("list_inhouse",{keyPath:"listinhouse_id",autoIncrement:!0})).createIndex("objtypename","objecttype_name",{unique:!1}),e.db.objectStoreNames.contains("check_itemlist")||(n=e.db.createObjectStore("check_itemlist",{keyPath:"item_id",autoIncrement:!0})).createIndex("checkup_position",["checkup_id","pro_position_id"],{unique:!1}),e.db.objectStoreNames.contains("check_itemlist_new")||(n=e.db.createObjectStore("check_itemlist_new",{keyPath:"item_new_id",autoIncrement:!0})).createIndex("checkup_position_type",["checkup_id","position_id","template_type"],{unique:!1}),e.db.objectStoreNames.contains("check_typelist")||e.db.createObjectStore("check_typelist",{keyPath:"dic_id",autoIncrement:!1}),e.db.objectStoreNames.contains("que_type_item")||(n=e.db.createObjectStore("que_type_item",{keyPath:"que_type_item_id",autoIncrement:!0})).createIndex("position_id",["position_id"],{unique:!1}),e.db.objectStoreNames.contains("que_type_item")||(n=e.db.createObjectStore("que_type_item",{keyPath:"que_type_item_id",autoIncrement:!0})).createIndex("position_id",["position_id"],{unique:!1}),e.db.objectStoreNames.contains("account_list")||((n=e.db.createObjectStore("account_list",{keyPath:"account_id",autoIncrement:!0})).createIndex("accountType","accounttype",{unique:!1}),n.createIndex("companyName","companyname",{unique:!1}),n.createIndex("contractTypeId","contracttypeid",{unique:!1}),n.createIndex("contractId","contractid",{unique:!1})),e.db.objectStoreNames.contains("account_list_2")||((n=e.db.createObjectStore("account_list_2",{keyPath:"account_id",autoIncrement:!0})).createIndex("accountType","accounttype",{unique:!1}),n.createIndex("companyName","companyname",{unique:!1}),n.createIndex("contractTypeId","contracttypeid",{unique:!1}),n.createIndex("contractId","contractid",{unique:!1})),e.db.objectStoreNames.contains("accounttype_list")||(n=e.db.createObjectStore("accounttype_list",{keyPath:"accounttype_id",autoIncrement:!0})),e.db.objectStoreNames.contains("accounttype_list_2")||(n=e.db.createObjectStore("accounttype_list_2",{keyPath:"accounttype_id",autoIncrement:!0})),e.db.objectStoreNames.contains("que_reason_list")||(n=e.db.createObjectStore("que_reason_list",{keyPath:"que_reason_id",autoIncrement:!0})),e.db.objectStoreNames.contains("que_overdue_reason_list")||(n=e.db.createObjectStore("que_overdue_reason_list",{keyPath:"que_overdue_reason_id",autoIncrement:!0})),e.db.objectStoreNames.contains("rect_register_list")||(n=e.db.createObjectStore("rect_register_list",{keyPath:"rect_register_id",autoIncrement:!0})),e.db.objectStoreNames.contains("rect_feedback_list")||(n=e.db.createObjectStore("rect_feedback_list",{keyPath:"rect_feedback_id",autoIncrement:!0})),e.db.objectStoreNames.contains("rect_urge_list")||(n=e.db.createObjectStore("rect_urge_list",{keyPath:"rect_urge_id",autoIncrement:!0})),e.db.objectStoreNames.contains("rect_accept_list")||(n=e.db.createObjectStore("rect_accept_list",{keyPath:"rect_accept_id",autoIncrement:!0})),e.db.objectStoreNames.contains("check_type_list")||(n=e.db.createObjectStore("check_type_list",{keyPath:"check_type_id",autoIncrement:!0})).createIndex("parIdCheckType",["tree_parid","checkup_id"],{unique:!1}),e.db.objectStoreNames.contains("search_que_man_list")||(n=e.db.createObjectStore("search_que_man_list",{keyPath:"search_que_man_id",autoIncrement:!0})).createIndex("manname","manname",{unique:!1}),e.db.objectStoreNames.contains("search_que_con_list")||(n=e.db.createObjectStore("search_que_con_list",{keyPath:"search_que_con_id",autoIncrement:!0})).createIndex("conname","conname",{unique:!1}),e.db.objectStoreNames.contains("search_que_building_list")||(n=e.db.createObjectStore("search_que_building_list",{keyPath:"search_que_building_name",autoIncrement:!0})).createIndex("roomname","roomname",{unique:!1}),console.log(555)}}else n("\u6682\u4e0d\u652f\u6301\u6570\u636e\u7f13\u5b58")}})},e.prototype.initDB=function(){return this.createDB()},e.prototype.closeDB=function(){console.log("\u5173\u95ed\u6570\u636e\u5e93\uff1a"+this.db),this.db&&this.db.close()},e.prototype.deleteDB=function(){console.log("\u5220\u9664\u6570\u636e\u5e93\uff1a",this.db),window.indexedDB.deleteDatabase(this.getDBName()),localStorage.removeItem("db.name"),this.db=null},e.prototype.clearTable=function(e){console.log("\u6e05\u9664\u8868\uff1a"+e),this.db.transaction([e],"readwrite").objectStore(e).clear()},e.prototype.insert=function(e,t,n,o){void 0===o&&(o=!1);var i=this.db.transaction([e],"readwrite").objectStore(e);o&&i.clear(),console.log("\u63d2\u5165\u6570\u636e\uff1a"+e);var r=[],c=[],s=[],u=0;if(t.forEach(function(a){if("que_list"===e){var o=Object.assign({},a);r.push({conid:o.contracttypeid,conname:o.contracttypename}),c.push({manid:o.reg_manid,manname:o.reg_manname}),s.push({roomname:o.roomname})}var d=i.add(a);d.onsuccess=function(e){++u===t.length&&n&&n()},d.onerror=function(e){++u===t.length&&n&&n()}}),"que_list"===e){console.log(r),console.log(c),console.log(s);var d=this.db.transaction("search_que_con_list","readwrite").objectStore("search_que_con_list");d.clear();var l=this.db.transaction("search_que_man_list","readwrite").objectStore("search_que_man_list");l.clear();var p=this.db.transaction("search_que_building_list","readwrite").objectStore("search_que_building_list");p.clear(),r.sort(function(e,t){return e.conname>t.conname?1:-1}),c.sort(function(e,t){return e.manname>t.manname?1:-1}),s.sort(function(e,t){return e.roomname>t.roomname?1:-1}),a.a.unique_conid(r).forEach(function(e){d.add(e)}),a.a.unique_manid(c).forEach(function(e){l.add(e)}),a.a.unique_roomname(s).forEach(function(e){p.add(e)})}},e.prototype.delete=function(e,t,n){void 0===t&&(t=[]);var a=this.db.transaction([e],"readwrite").objectStore(e),o=[],i=[];t.forEach(function(e){var t=a.delete(e),n=new Promise(function(n,a){t.onsuccess=function(t){i.push(e)},t.onerror=function(e){}});o.push(n)}),Promise.all(o).then(function(){n&&n(i)})},e.prototype.update=function(e,t,n){void 0===t&&(t=[]);var a=this.db.transaction([e],"readwrite").objectStore(e),o=0;t.forEach(function(e){var i=a.put(e);i.onsuccess=function(e){++o===t.length&&n&&n()},i.onerror=function(e){}})},e.prototype.select=function(e,t,n,a){void 0===t&&(t=[]),void 0===n&&(n={}),void 0===a&&(a=null),console.log(e);var o=this.db.transaction([e],"readwrite").objectStore(e);if(0===t.length){var i=[];o.openCursor().onsuccess=function(e){var t=e.target.result;t?(i.push(t.value),t.continue()):a&&a(i)}}},e.prototype.getBuildings=function(e,t,n,a,o,i){void 0===t&&(t=null),void 0===n&&(n=0);var r="0"===o?"project_tree":"task_list_2";"1"==e?this.getSingleCondData(r,"type_isfq",0==n?"0"===o?["\u697c\u680b","0"]:["\u697c\u680b","0",i]:"0"===o?["\u5206\u533a","1"]:["\u5206\u533a","1",i],a):this.getSingleCondData(r,"parid_isfq","0"===o?[t,n.toString()]:[t,n.toString(),i],a)},e.prototype.getListInhouse=function(e,t){this.getSingleCondData("task_list_3","planDid",e,t)},e.prototype.getPartialsInHouse=function(e,t,n){this.getSingleCondData("check_itemlist","checkup_position",[e,t],n)},e.prototype.getPartialsInHouse2=function(e,t,n,a){this.getSingleCondData("check_itemlist_new","checkup_position_type",[t,n,e],a)},e.prototype.getSingleCondData=function(e,t,n,a){console.info(e,"-",t,"-",n);var o=this.db.transaction([e],"readwrite").objectStore(e).index(t),i=IDBKeyRange.only(n),r=o.openCursor(i);r.onerror=function(e){console.log(e.target.error.message),a&&a(null)};var c=[];r.onsuccess=function(e){var t=e.target.result;t?(c.push(t.value),t.continue()):a&&a(c)}},e.prototype.disposeDB=function(){var e=this;return new Promise(function(t){e.db.close(),window.indexedDB.deleteDatabase(e.getDBName()),t()})},e.ngInjectableDef=o.defineInjectable({factory:function(){return new e},token:e,providedIn:"root"}),e}()},fLog:function(e,t,n){"use strict";n.d(t,"e",function(){return c}),n.d(t,"l",function(){return s}),n.d(t,"m",function(){return u}),n.d(t,"n",function(){return d}),n.d(t,"d",function(){return l}),n.d(t,"a",function(){return p}),n.d(t,"b",function(){return h}),n.d(t,"c",function(){return _}),n.d(t,"f",function(){return m}),n.d(t,"g",function(){return b}),n.d(t,"h",function(){return f}),n.d(t,"i",function(){return y}),n.d(t,"k",function(){return v}),n.d(t,"j",function(){return I});var a=n("ajt+"),o=n("H+bZ"),i=n("sJLo"),r=n("CcnG"),c="que_list",s="task_list_1",u="task_list_2",d="task_list_3",l="check_typelist",p="account_list",h="account_list_2",_="accounttype_list",m="que_list_annexs",b="que_list_record",f="que_overdue_reason_list",y="que_reason_list",g=[{name:"\u8d28\u68c0\u95ee\u9898",uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u63d0\u95ee\u9898APP",params:["problem_id","plan_mid","project_id","object_type","object_name","position_desc","problem_name","unittype","from_type","comp_fields","comp_values"],table:"add_que",pri_key:"addque_id",needRemove:!0,attachTable:"H_QA_Problem_Annex",attachField:"Annex_ID",totalItems:[],totalSize:0,doneItems:[]},{name:"\u8d28\u68c0\u9879",uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u786e\u8ba4\u8ba1\u5212APP",params:["plan_mid","object_type","object_id","pro_position_id","qaitem_id","man_id","is_problem"],table:d,totalItems:[],totalSize:0,doneItems:[]},{name:"\u6574\u6539\u767b\u8bb0",uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u95ee\u9898\u6574\u6539APP",params:["problemId","rectManId","rectDate","rectDesc","rectType","queResonId","createId","fromType","overdueReasonId","overdueDesc"],table:"rect_register_list",pri_key:"rect_register_id",needRemove:!0,attachTable:"H_QA_Problem_Annex",attachField:"Annex_ID",totalItems:[],totalSize:0,doneItems:[]},{name:"\u6574\u6539\u53cd\u9988",uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u95ee\u9898\u53cd\u9988APP",params:["problemId","createId","receiveID","queRisk","queprog","queDate","backDesc"],table:"rect_feedback_list",pri_key:"rect_feedback_id",needRemove:!0,attachTable:"H_QA_Problem_Annex",attachField:"Annex_ID",totalItems:[],totalSize:0,doneItems:[]},{name:"\u6574\u6539\u50ac\u529e",uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u6574\u6539\u50ac\u529eAPP",params:["problemId","createId","receiveId","urgeDesc"],table:"rect_urge_list",pri_key:"rect_urge_id",needRemove:!0,totalItems:[],totalSize:0,doneItems:[]},{name:"\u6574\u6539\u9a8c\u6536",uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u95ee\u9898\u9a8c\u6536APP",params:["problemId","rectID","accpetManId","isPass","acceptDesc","fromType","acceptDate"],table:"rect_accept_list",pri_key:"rect_accept_id",needRemove:!0,attachTable:"H_QA_Problem_Annex",attachField:"Annex_ID",totalItems:[],totalSize:0,doneItems:[]}],v=[{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u8d28\u68c0\u4efb\u52a1\u5217\u8868APP",params:["manid","0","-1","0"],table:s},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u8d28\u68c0\u4efb\u52a1\u5217\u8868APP",params:["manid","3","0","0","0"],table:d},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u8d28\u68c0\u4efb\u52a1\u5217\u8868APP",params:["manid","2","0","0","0"],table:u},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u9879\u76ee\u6811APP",params:["1"],table:"project_tree"},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u68c0\u67e5\u7c7b\u578b\u5217\u8868APP",params:["589"],table:l,need_project:"0"},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u623f\u95f4\u90e8\u4f4d\u5217\u8868APP",params:[],table:"list_inhouse"},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u90e8\u4f4d\u68c0\u67e5\u9879APP",params:["0"],table:"check_itemlist_new"},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u8d26\u6237\u4fe1\u606fAPP",params:["0","","","",""],table:p},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u8d26\u6237\u4fe1\u606f2APP",params:[],table:h},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u95ee\u9898\u6e05\u5355APP",params:["manid","0","0","-1","0","0","0","","","-1"],table:c},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u68c0\u67e5\u7c7b\u578b\u5217\u8868APP",params:["646"],table:_,need_project:"0"},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u68c0\u67e5\u7c7b\u578b\u5217\u8868APP",params:["616"],table:"que_level_list",need_project:"0"},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u68c0\u67e5\u7c7b\u578b\u5217\u8868APP",params:["619"],table:y,need_project:"0"},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u68c0\u67e5\u7c7b\u578b\u5217\u8868APP",params:["640"],table:f,need_project:"0"},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u95ee\u9898\u6e05\u5355APP",params:["manid","1","0","-1","0","0","0","","","-1"],table:m,imageDownloadField:"annex_url"},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u95ee\u9898\u6e05\u5355APP",params:["manid","2","0","-1","0","0","0","","","-1"],table:b},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u95ee\u9898\u6e05\u5355APP",params:["manid","3","0","-1","0","0","0","","","-1"],table:"que_list_contracttype"},{uri:null,dotype:"GetData",funname:"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u5206\u7c7b\u68c0\u67e5\u9879APP",params:[],table:"check_type_list",need_project:"1"}],I=function(){function e(e,t){this.db=e,this.api=t,this.counter=0,this.needSyncCount=0,this.currSyncCount=0,this.currAnnexes=[]}return e.prototype.getProject=function(){return JSON.parse(localStorage.getItem("project"))},e.prototype.saveProject=function(e,t){localStorage.setItem("project",JSON.stringify({id:e,name:t}))},e.prototype.syncServerToLocal=function(e,t){this.startOfflineData(e,t)},e.prototype.syncToServerCheck=function(e){var t=this,n=0,a=0;g.forEach(function(o){t.db.initDB().then(function(){o.needRemove?t.db.select(o.table,[],{},function(i){o.totalItems=i,o.totalSize=i.length,a+=i.length,++n===g.length&&e&&(t.needSyncCount=a,e(a))}):t.db.getSingleCondData(o.table,"isUpdate","1",function(i){console.log(i),o.totalItems=i,o.totalSize=i.length,a+=i.length,++n===g.length&&e&&(t.needSyncCount=a,e(a))})})})},e.prototype.syncLocalToServer=function(e,t){var n=this;this.currSyncCount=0,g.forEach(function(a){a.totalItems.forEach(a.attachTable&&a.attachField?function(o){var r=o.annexes||o.images;if(r){r=r.split("|");var c=new FormData;c.append("mid","0"),c.append("domanid",i.a.getManID()),c.append("tablename",a.attachTable),c.append("fieldname",a.attachField);var s=0;r.forEach(function(e){c.append("file",n.dataURItoBlob(e),"image"+s+++".jpg")}),n.api.upload(c,"",!1).then(function(r){if("0"===r.code){var c=r.IDS,s={};s.dotype=a.dotype,s.funname=a.funname;var u=Object.assign({},o);u.project_id=n.getProject().id,u.man_id=i.a.getManID();var d=1;a.params.forEach(function(e){var t=(u[e]||"").toString();s["param"+d]=t.replace(/NULL/g,""),d++}),s["param"+d]=c,n.api.POST(null,s,"",!1).then(function(i){0===i.code&&i.data&&i.data.length>0&&"1"===i.data[0].ihint_type?(n.db.initDB().then(function(){n.db.delete(a.table,[o[a.pri_key]],function(){})}),n.syncCallback(e,t,"1")):n.syncCallback(e,t,"0")}).catch(function(a){n.syncCallback(e,t,"0")})}else n.syncCallback(e,t,"0")}).catch(function(a){n.syncCallback(e,t,"0")})}else{console.log("\u65e0\u9644\u4ef6");var u={};u.dotype=a.dotype,u.funname=a.funname;var d=Object.assign({},o);d.project_id=n.getProject().id,d.man_id=i.a.getManID(),console.log(o);var l=1;a.params.forEach(function(e){console.log(e);var t=(d[e]||"").toString();u["param"+l]=t.replace(/NULL/g,""),l++}),u["param"+l]="",n.api.POST(null,u,"",!1).then(function(i){0===i.code&&i.data&&i.data.length>0&&"1"===i.data[0].ihint_type?(n.db.initDB().then(function(){n.db.delete(a.table,[o[a.pri_key]],function(){})}),n.syncCallback(e,t,"1")):n.syncCallback(e,t,"0")}).catch(function(a){n.syncCallback(e,t,"0")})}}:function(o){var r={};r.dotype=a.dotype,r.funname=a.funname;var c=Object.assign({},o);c.project_id=n.getProject().id,c.man_id=i.a.getManID();var s=1;a.params.forEach(function(e){var t=(c[e]||"").toString();r["param"+s]=t.replace(/NULL/g,""),s++}),console.log(o),console.log("\u53c2\u6570\uff1a"+r);var u=Object.assign({},o);u.isupdate="0",n.api.POST(null,r,"",!1).then(function(i){0===i.code&&i.data&&i.data.length>0&&"1"===i.data[0].ihint_type&&n.db.initDB().then(function(){a.needRemove?n.db.delete(a.table,[o[a.pri_key]],function(){}):n.db.update(a.table,[u],null)}),n.syncCallback(e,t,"1")}).catch(function(a){n.syncCallback(e,t,"0")})})})},e.prototype.syncCallback=function(e,t,n){++this.currSyncCount===this.needSyncCount&&t&&t(),console.log(this.currSyncCount),e&&e(this.currSyncCount)},e.prototype.dataURItoBlob=function(e){for(var t=atob(e.split(",")[1]),n=e.split(",")[0].split(":")[1].split(";")[0],a=new ArrayBuffer(t.length),o=new Uint8Array(a),i=0;i<t.length;i++)o[i]=t.charCodeAt(i);return new Blob([a],{type:n})},e.prototype.syncSingleTable=function(e,t){var n=this,a=this.getProject(),o={};if(o.dotype=e.dotype,o.funname=e.funname,e.params){var r=void 0;"0"===e.need_project?r=1:(o.param1=a.id||"0",r=2),"\u8d28\u68c0\u7cfb\u7edf\u83b7\u53d6\u8d26\u6237\u4fe1\u606f2APP"===e.funname&&console.log("fsdfs");for(var c=0;c<e.params.length;c++)o["param"+(r+c)]="manid"===e.params[c]?i.a.getManID():e.params[c]}this.api.POST(e.uri,o,"",!1).then(function(a){if(0===a.code&&0===(a.data||[]).length)return n.db.clearTable(e.table),void(t&&t());if(e.imageDownloadField){var o=a.data||[];n.currAnnexes=[];var i=0;o.forEach(function(r){n.db.getSingleCondData("que_list_annexs","ID",r.annex_id,function(c){if(console.log(a),c.length>0&&c[0].annex_data&&"NULL"!==c[0].annex_data)++i===o.length&&t&&t();else if("1"===sessionStorage.getItem("need.sync.all")){var s=r[e.imageDownloadField],u=new Image;u.crossOrigin="anonymous",u.onload=function(){var e=document.createElement("canvas");e.width=u.width,e.height=u.height,e.getContext("2d").drawImage(u,0,0,u.width,u.height);var a=e.toDataURL("image/jpeg",1);r.annex_data=a,e=null,c.length>0&&n.db.delete(m,[c[0].que_annex_id],null),n.db.insert(m,[r],function(){++i===o.length&&t&&t()},!1)},u.onerror=function(){++i===o.length&&t&&t()},u.src=s}else 0===c.length?n.db.insert(m,[r],function(){++i===o.length&&t&&t()},!1):++i===o.length&&t&&t()})})}else n.saveData(e.table,a.data,function(){t&&t()})}).catch(function(e){t&&t()})},e.prototype.doSaveAnnexes=function(e){var t=this;this.db.initDB().then(function(){t.db.insert(m,t.currAnnexes,function(){t.currAnnexes=[],e&&e()},!0)})},e.prototype.startOfflineData=function(e,t){var n=this;this.counter=0;for(var a=0,o=v;a<o.length;a++)this.syncSingleTable(o[a],function(){++n.counter===v.length&&t&&t(),e&&e(n.counter)})},e.prototype.saveData=function(e,t,n){var a=this;this.db.initDB().then(function(){a.db.insert(e,t,function(e){n()},!0)})},e.ngInjectableDef=r.defineInjectable({factory:function(){return new e(r.inject(a.a),r.inject(o.a))},token:e,providedIn:"root"}),e}()}}]);